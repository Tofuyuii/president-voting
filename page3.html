<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ลานพฤกษา</title>
<link rel="stylesheet" href="style.css">
</head>

<body onload="loadPage()">

<h2>ลานพฤกษา</h2>

<input id="pass" placeholder="ใส่รหัส">
<button onclick="unlock()">ปลดล็อก</button>
<p id="status"></p>

<div class="card">ผู้สมัคร 1 <input id="p3_c1" class="score" onclick="add(this)" oninput="manual(this)"></div>
<div class="card">ผู้สมัคร 2 <input id="p3_c2" class="score" onclick="add(this)" oninput="manual(this)"></div>
<div class="card">บัตรเสีย <input id="p3_bad" class="score" onclick="add(this)" oninput="manual(this)"></div>
<div class="card">ไม่ประสงค์ <input id="p3_no" class="score" onclick="add(this)" oninput="manual(this)"></div>

<button onclick="resetPage()">รีเซ็ต</button>

<script>
let unlocked=false;
let PASSWORD="src1234";
function unlock(){
 if(pass.value===PASSWORD){
  unlocked=true;
  status.innerText="ปลดล็อกแล้ว";
 } else alert("รหัสผิด");
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyCkpZBG5ElQT0dPRsQaBJm3_b82aFcybpI",
 authDomain:"president-voting.firebaseapp.com",
 databaseURL:"https://president-voting-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"president-voting",
 storageBucket:"president-voting.firebasestorage.app",
 messagingSenderId:"427343583507",
 appId:"1:427343583507:web:cedc455f0e035d50b5e2e6"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

window.add=async(el)=>{
 if(!unlocked)return alert("ต้องปลดล็อกก่อน");
 const r=ref(db,"scores/"+el.id);
 const s=await get(r);
 const v=(s.val()||0)+1;
 el.value=v;
 await set(r,v);
};

window.manual=async(el)=>{
 if(!unlocked)return alert("ต้องปลดล็อกก่อน");
 let v=Number(el.value)||0;
 await set(ref(db,"scores/"+el.id),v);
};

window.loadPage=async()=>{
 const s=await get(ref(db,"scores"));
 const d=s.val()||{};
 document.querySelectorAll(".score").forEach(b=>{
  b.value=d[b.id]||0;
 });
};

window.resetPage=async()=>{
 if(!unlocked)return alert("ต้องปลดล็อกก่อน");
 if(!confirm("รีเซ็ต?"))return;
 let obj={};
 document.querySelectorAll(".score").forEach(b=>{
  obj[b.id]=0;
  b.value=0;
 });
 await update(ref(db,"scores"),obj);
};
</script>

</body>
</html>
